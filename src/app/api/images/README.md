# Images API với OpenAI Integration

API này đã được nâng cấp để tích hợp với OpenAI DALL-E cho việc sinh ảnh từ text prompts và xử lý ảnh upload.

## Endpoints

### POST `/api/images`

#### 1. Sinh ảnh từ text prompt (JSON)
```javascript
const response = await fetch('/api/images', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    action: 'generate',
    prompt: 'Một con mèo đang chơi trong vườn hoa',
    settings: {
      size: '1024x1024',
      quality: 'hd',
      style: 'realistic', // hoặc 'artistic', 'photographic', 'digital-art'
      platform: 'custom'
    },
    caption: 'Generated by AI'
  })
});
```

#### 2. Sinh ảnh từ text prompt (Form Data)
```javascript
const formData = new FormData();
formData.append('action', 'generate');
formData.append('prompt', 'Một thành phố tương lai với những tòa nhà cao tầng');
formData.append('size', '1024x1792');
formData.append('quality', 'hd');
formData.append('style', 'digital-art');

const response = await fetch('/api/images', {
  method: 'POST',
  body: formData
});
```

#### 3. Chỉnh sửa ảnh với mask (Edit Image)
```javascript
const formData = new FormData();
formData.append('action', 'edit');
formData.append('prompt', 'Thay thế bầu trời bằng hoàng hôn đẹp');
formData.append('image', imageFile); // File object
formData.append('mask', maskFile);   // File object (optional)
formData.append('size', '1024x1024');

const response = await fetch('/api/images', {
  method: 'POST',
  body: formData
});
```

#### 4. Tạo biến thể ảnh (Image Variations)
```javascript
const formData = new FormData();
formData.append('action', 'variations');
formData.append('image', imageFile); // File object
formData.append('n', '3'); // Số lượng biến thể (tối đa 4)
formData.append('size', '1024x1024');

const response = await fetch('/api/images', {
  method: 'POST',
  body: formData
});
```

#### 5. Lưu ảnh có sẵn (Original functionality)
```javascript
const response = await fetch('/api/images', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    imageUrl: '/uploads/existing-image.png',
    prompt: 'Mô tả ảnh',
    caption: 'Caption cho ảnh',
    settings: {
      style: 'realistic',
      size: '1024x1024',
      platform: 'instagram',
      quality: 'standard'
    }
  })
});
```

### GET `/api/images`

Lấy danh sách ảnh của user:

```javascript
const response = await fetch('/api/images', {
  method: 'GET'
});

const data = await response.json();
// data.images sẽ chứa array các ảnh của user
```

## Các tham số

### `action` (cho form data)
- `generate`: Sinh ảnh mới từ text prompt
- `edit`: Chỉnh sửa ảnh với mask
- `variations`: Tạo biến thể của ảnh

### `style`
- `realistic`: Phong cách thực tế (natural)
- `artistic`: Phong cách nghệ thuật với màu sắc rực rỡ
- `photographic`: Phong cách nhiếp ảnh chuyên nghiệp
- `digital-art`: Phong cách digital art hiện đại

### `size`
- `1024x1024`: Vuông (mặc định)
- `1024x1792`: Dọc
- `1792x1024`: Ngang

### `quality`
- `standard`: Chất lượng chuẩn (mặc định)
- `hd`: Chất lượng cao

## Response Format

### Thành công
```json
{
  "success": true,
  "message": "Image generated successfully",
  "image": {
    "id": "img_123",
    "imageUrl": "/uploads/generated_image.png",
    "prompt": "Enhanced prompt used",
    "caption": "User caption",
    "style": "realistic",
    "size": "1024x1024",
    "platform": "custom",
    "createdAt": "2024-01-01T12:00:00Z"
  },
  "revisedPrompt": "AI enhanced version of the prompt" // Chỉ cho DALL-E 3
}
```

### Lỗi
```json
{
  "error": "Error message",
  "details": "Detailed error information"
}
```

## Ví dụ sử dụng trong React

```jsx
import { useState } from 'react';

function ImageGenerator() {
  const [prompt, setPrompt] = useState('');
  const [generatedImage, setGeneratedImage] = useState(null);
  const [isLoading, setIsLoading] = useState(false);

  const generateImage = async () => {
    setIsLoading(true);
    try {
      const response = await fetch('/api/images', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          action: 'generate',
          prompt: prompt,
          settings: {
            size: '1024x1024',
            quality: 'hd',
            style: 'artistic'
          }
        })
      });

      const data = await response.json();
      if (data.success) {
        setGeneratedImage(data.image);
      }
    } catch (error) {
      console.error('Error:', error);
    } finally {
      setIsLoading(false);
    }
  };

  const uploadAndEdit = async (file, mask = null) => {
    const formData = new FormData();
    formData.append('action', 'edit');
    formData.append('prompt', 'Thêm bầu trời đẹp');
    formData.append('image', file);
    if (mask) formData.append('mask', mask);
    
    const response = await fetch('/api/images', {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    return data;
  };

  return (
    <div>
      <input 
        value={prompt}
        onChange={(e) => setPrompt(e.target.value)}
        placeholder="Nhập mô tả ảnh..."
      />
      <button onClick={generateImage} disabled={isLoading}>
        {isLoading ? 'Đang sinh ảnh...' : 'Sinh ảnh'}
      </button>
      
      {generatedImage && (
        <img src={generatedImage.imageUrl} alt={generatedImage.prompt} />
      )}
    </div>
  );
}
```

## Lưu ý quan trọng

1. **Environment Variables**: Cần thiết lập `OPENAI_API_KEY` trong `.env.local`
2. **File Size**: Giới hạn file upload tối đa 5MB
3. **Rate Limits**: Tuân thủ rate limits của OpenAI API
4. **Authentication**: Tất cả requests cần authentication
5. **Error Handling**: Luôn kiểm tra response và xử lý errors appropriately

## Supported File Types

- **Upload**: JPG, PNG, WebP
- **Output**: PNG (được convert và lưu cục bộ) 